---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: op-token-generator
  namespace: onepassword
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: op-token-generator
  namespace: onepassword
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["create", "get", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: op-token-generator
  namespace: onepassword
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: op-token-generator
subjects:
  - kind: ServiceAccount
    name: op-token-generator
    namespace: onepassword
---
apiVersion: batch/v1
kind: Job
metadata:
  name: op-token-generator
  namespace: onepassword
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      serviceAccountName: op-token-generator
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-connect
          image: curlimages/curl:latest
          command:
            - sh
            - -c
            - |
              until curl -f http://onepassword-connect:8080/health; do
                echo "Waiting for Connect API..."
                sleep 5
              done
      containers:
        - name: generate-token
          image: curlimages/curl:latest
          command:
            - sh
            - -c
            - |
              # Check if secret already exists
              if kubectl get secret onepassword-token -n onepassword 2>/dev/null; then
                echo "Token secret already exists, skipping generation"
                exit 0
              fi

              # Generate token from Connect API
              TOKEN=$(curl -s -X POST http://onepassword-connect:8080/v1/connect/tokens \
                -H "Content-Type: application/json" \
                -d '{"name":"operator-token","features":["manage:vaults"]}' | \
                grep -o '"token":"[^"]*"' | cut -d'"' -f4)

              if [ -z "$TOKEN" ]; then
                echo "Failed to generate token"
                exit 1
              fi

              # Create secret
              kubectl create secret generic onepassword-token \
                --from-literal=token=$TOKEN \
                --namespace=onepassword

              echo "Token generated and secret created successfully"
          volumeMounts:
            - name: kube-api-access
              mountPath: /var/run/secrets/kubernetes.io/serviceaccount
              readOnly: true
      volumes:
        - name: kube-api-access
          projected:
            sources:
              - serviceAccountToken:
                  path: token
              - configMap:
                  name: kube-root-ca.crt
                  items:
                    - key: ca.crt
                      path: ca.crt

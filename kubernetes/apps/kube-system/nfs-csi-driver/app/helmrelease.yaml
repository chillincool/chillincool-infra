---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: csi-driver-nfs
  namespace: kube-system
spec:
  interval: 30m
  chart:
    spec:
      chart: csi-driver-nfs
      version: "v4.10.0"
      sourceRef:
        kind: HelmRepository
        name: csi-driver-nfs
        namespace: flux-system
  install:
    crds: Create
    remediation:
      retries: 3
  upgrade:
    crds: CreateReplace
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    driver:
      name: nfs.csi.k8s.io

    image:
      nfs:
        repository: registry.k8s.io/sig-storage/nfsplugin
        tag: v4.10.0
      csiProvisioner:
        repository: registry.k8s.io/sig-storage/csi-provisioner
        tag: v5.1.0
      livenessProbe:
        repository: registry.k8s.io/sig-storage/livenessprobe
        tag: v2.14.0
      nodeDriverRegistrar:
        repository: registry.k8s.io/sig-storage/csi-node-driver-registrar
        tag: v2.12.0

    controller:
      replicas: 1
      runOnControlPlane: true
      resources:
        limits:
          memory: 200Mi
        requests:
          cpu: 10m
          memory: 20Mi

    node:
      resources:
        limits:
          memory: 300Mi
        requests:
          cpu: 10m
          memory: 20Mi

    # NFS mounts happen in pod namespace, not host namespace
    # This bypasses Cilium socket BPF issues
    kubeletDir: /var/lib/kubelet

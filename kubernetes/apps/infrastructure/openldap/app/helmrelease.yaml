---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: openldap
  namespace: openldap
spec:
  interval: 30m
  chart:
    spec:
      chart: openldap-stack-ha
      version: 4.x.x
      sourceRef:
        kind: HelmRepository
        name: jp-gouin
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    # Global LDAP configuration
    global:
      ldapDomain: chillincool.net
      existingSecret: openldap-admin
      adminUser: admin
      configUser: admin

    # OpenLDAP server configuration
    replicaCount: 1

    # Persistence
    persistence:
      enabled: true
      storageClass: longhorn
      size: 2Gi
      accessMode: ReadWriteOnce

    # Custom LDIF for base organizational structure
    # Users/groups will be managed via Terraform
    customLdifFiles:
      00-base-dn.ldif: |
        # Base DN for chillincool.net domain
        # The chart doesn't auto-create this, so it must be in customLdifFiles
        dn: dc=chillincool,dc=net
        objectClass: dcObject
        objectClass: organization
        dc: chillincool
        o: Chillincool

      01-base-structure.ldif: |
        # Base organizational units for chillincool.net
        # This creates the container structure - actual users/groups managed via Terraform

        dn: ou=users,dc=chillincool,dc=net
        objectClass: organizationalUnit
        ou: users
        description: User accounts container

        dn: ou=groups,dc=chillincool,dc=net
        objectClass: organizationalUnit
        ou: groups
        description: Groups container

        dn: ou=services,dc=chillincool,dc=net
        objectClass: organizationalUnit
        ou: services
        description: Service accounts container (Keycloak, readonly, etc.)

    # TLS/LDAPS configuration
    # Re-enabled with step-ca certificates for debugging
    initTLSSecret:
      tls_enabled: true
      secret: openldap-tls

    # Additional LDAP environment variables for TLS security
    env:
      # Enforce minimum TLS version (disable older protocols)
      LDAP_TLS_PROTOCOL_MIN: "3.3"  # TLS 1.2+
      # TLS cipher suite - use broader set for compatibility
      LDAP_TLS_CIPHER_SUITE: "HIGH:MEDIUM:+3DES:!aNULL:!MD5"
      # TLS verification - try to verify client certs if presented, but allow connections without
      LDAP_TLS_VERIFY_CLIENT: "try"  # Options: never, allow, try, demand
      # Log level (stats, recommended for production)
      LDAP_LOGLEVEL: "256"  # 256 = stats, 0 = none, -1 = everything

    # phpLDAPadmin web UI
    # Disabled - will deploy separately to avoid chart defaults causing issues
    phpldapadmin:
      enabled: false

    # Self-service password tool (optional, disable for now)
    ltb-passwd:
      enabled: false

    # Lifecycle hooks to configure TLS and apply custom LDIFs on startup
    # This is necessary because the Bitnami init script doesn't configure TLS
    # in slapd cn=config and doesn't apply custom LDIFs when it detects existing data
    lifecycleHooks:
      postStart:
        exec:
          command:
            - /bin/bash
            - -c
            - |
              # Wait for slapd to be ready
              for i in {1..30}; do
                if ldapsearch -Y EXTERNAL -H ldapi:/// -b "cn=config" -s base &>/dev/null; then
                  break
                fi
                sleep 1
              done
              
              # Check if TLS is already configured
              if ldapsearch -Y EXTERNAL -H ldapi:/// -b "cn=config" "(olcTLSCertificateFile=*)" 2>/dev/null | grep -q "numEntries: 0"; then
                # Apply TLS configuration including verify client setting
                printf 'dn: cn=config\nchangetype: modify\nadd: olcTLSCertificateFile\nolcTLSCertificateFile: /opt/bitnami/openldap/certs/tls.crt\n-\nadd: olcTLSCertificateKeyFile\nolcTLSCertificateKeyFile: /opt/bitnami/openldap/certs/tls.key\n-\nadd: olcTLSCACertificateFile\nolcTLSCACertificateFile: /opt/bitnami/openldap/certs/ca.crt\n-\nadd: olcTLSVerifyClient\nolcTLSVerifyClient: try\n' | ldapmodify -Y EXTERNAL -H ldapi:/// 2>&1 | grep -v "SASL"
              else
                # TLS certs exist, check if verify client is configured
                if ! ldapsearch -Y EXTERNAL -H ldapi:/// -LLL -b "cn=config" -s base olcTLSVerifyClient 2>/dev/null | grep -q "olcTLSVerifyClient:"; then
                  # Add TLS verify client setting
                  printf 'dn: cn=config\nchangetype: modify\nadd: olcTLSVerifyClient\nolcTLSVerifyClient: try\n' | ldapmodify -Y EXTERNAL -H ldapi:/// 2>&1 | grep -v "SASL"
                fi
              fi
              
              # Check if base DN exists, if not apply custom LDIFs
              if ! ldapsearch -x -H ldap://localhost:1389 -D "cn=admin,dc=chillincool,dc=net" -w "$LDAP_ADMIN_PASSWORD" -b "dc=chillincool,dc=net" -s base &>/dev/null; then
                # Apply custom LDIFs
                printf 'dn: dc=chillincool,dc=net\nobjectClass: dcObject\nobjectClass: organization\ndc: chillincool\no: Chillincool\n\ndn: ou=users,dc=chillincool,dc=net\nobjectClass: organizationalUnit\nou: users\ndescription: User accounts container\n\ndn: ou=groups,dc=chillincool,dc=net\nobjectClass: organizationalUnit\nou: groups\ndescription: Groups container\n\ndn: ou=services,dc=chillincool,dc=net\nobjectClass: organizationalUnit\nou: services\ndescription: Service accounts container\n' | ldapadd -x -H ldap://localhost:1389 -D "cn=admin,dc=chillincool,dc=net" -w "$LDAP_ADMIN_PASSWORD" 2>&1 | grep -v "adding new entry"
              fi

    # Resource limits for OpenLDAP
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi

---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: openldap
  namespace: openldap
spec:
  interval: 30m
  chart:
    spec:
      chart: openldap-stack-ha
      version: 4.x.x
      sourceRef:
        kind: HelmRepository
        name: jp-gouin
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    # Global LDAP configuration
    global:
      ldapDomain: chillincool.net
      existingSecret: openldap-admin
      adminUser: admin
      configUser: admin

    # OpenLDAP server configuration
    replicaCount: 1

    # Persistence
    persistence:
      enabled: true
      storageClass: longhorn
      size: 2Gi
      accessMode: ReadWriteOnce

    # Custom LDIF for base organizational structure
    # Users/groups will be managed via Terraform
    customLdifFiles:
      00-base-dn.ldif: |
        # Base DN for chillincool.net domain
        # The chart doesn't auto-create this, so it must be in customLdifFiles
        dn: dc=chillincool,dc=net
        objectClass: dcObject
        objectClass: organization
        dc: chillincool
        o: Chillincool

      01-base-structure.ldif: |
        # Base organizational units for chillincool.net
        # This creates the container structure - actual users/groups managed via Terraform

        dn: ou=users,dc=chillincool,dc=net
        objectClass: organizationalUnit
        ou: users
        description: User accounts container

        dn: ou=groups,dc=chillincool,dc=net
        objectClass: organizationalUnit
        ou: groups
        description: Groups container

        dn: ou=services,dc=chillincool,dc=net
        objectClass: organizationalUnit
        ou: services
        description: Service accounts container (Keycloak, readonly, etc.)

    # TLS/LDAPS configuration
    # Re-enabled with step-ca certificates for debugging
    initTLSSecret:
      tls_enabled: true
      secret: openldap-tls

    # Additional LDAP environment variables for TLS security
    env:
      # Enforce minimum TLS version (disable older protocols)
      LDAP_TLS_PROTOCOL_MIN: "3.3"  # TLS 1.2+
      # TLS cipher suite - use broader set for compatibility
      LDAP_TLS_CIPHER_SUITE: "HIGH:MEDIUM:+3DES:!aNULL:!MD5"
      # TLS verification - require valid certs for replication
      LDAP_TLS_VERIFY_CLIENT: "never"  # Options: never, allow, try, demand
      # Log level (stats, recommended for production)
      LDAP_LOGLEVEL: "256"  # 256 = stats, 0 = none, -1 = everything

    # phpLDAPadmin web UI
    # Disabled - will deploy separately to avoid chart defaults causing issues
    phpldapadmin:
      enabled: false

    # Self-service password tool (optional, disable for now)
    ltb-passwd:
      enabled: false

    # Resource limits for OpenLDAP
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi

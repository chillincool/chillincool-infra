---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kometa
  namespace: media
spec:
  interval: 30m
  chart:
    spec:
      chart: kometa
      version: "0.x.x"
      sourceRef:
        kind: HelmRepository
        name: chillincool
        namespace: flux-system
  install:
    crds: Create
    remediation:
      retries: 3
  upgrade:
    crds: CreateReplace
    remediation:
      retries: 3
  values:
    service:
      type: ClusterIP
      port: 8080

    podSecurityContext:
      fsGroup: 568

    securityContext:
      runAsNonRoot: true
      runAsUser: 568
      runAsGroup: 568
      readOnlyRootFilesystem: false

    initContainers:
      - name: download-kometa-configs
        image: alpine/git:latest
        command:
          - sh
          - -c
          - |
            set -e
            echo "Cloning kometa-config..."
            cd /tmp
            git clone --depth 1 https://github.com/chillincool/kometa-config.git
            echo "Copying config.yml to /config/..."
            cp kometa-config/config.yml /config/config.yml
            echo "Copying other configs to /config/kometa/..."
            mkdir -p /config/kometa
            cp -r kometa-config/metadata /config/kometa/ 2>/dev/null || true
            cp -r kometa-config/overlays /config/kometa/ 2>/dev/null || true
            echo "Files copied:"
            ls -laR /config/
        volumeMounts:
          - name: config
            mountPath: /config

    persistence:
      config:
        enabled: true
        type: persistentVolumeClaim
        existingClaim: shared-app-config
        globalMounts:
          - path: /config
            subPath: kometa

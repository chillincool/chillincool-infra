---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: kometa
  namespace: media
spec:
  schedule: "0 3 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          initContainers:
            - name: download-kometa-configs
              image: alpine/git:latest
              command:
                - sh
                - -c
                - |
                  set -e
                  echo "Cloning kometa-config..."
                  cd /tmp
                  git clone --depth 1 https://github.com/chillincool/kometa-config.git
                  echo "Copying config.yml to /config/..."
                  cp kometa-config/config.yml /config/config.yml
                  echo "Copying other configs to /config/kometa/..."
                  mkdir -p /config/kometa
                  cp -r kometa-config/metadata /config/kometa/ 2>/dev/null || true
                  cp -r kometa-config/overlays /config/kometa/ 2>/dev/null || true
                  echo "Files copied:"
                  ls -laR /config/
              volumeMounts:
                - name: config-pvc
                  mountPath: /config
                  subPath: kometa
          containers:
            - name: kometa
              image: ghcr.io/chillincool/kometa:latest
              args:
                - --run
                - --read-only-config
              env:
                - name: PUID
                  value: "568"
                - name: PGID
                  value: "568"
                - name: TZ
                  value: "America/Chicago"
              volumeMounts:
                - name: config-pvc
                  mountPath: /config
                  subPath: kometa
          volumes:
            - name: config-pvc
              persistentVolumeClaim:
                claimName: shared-app-config

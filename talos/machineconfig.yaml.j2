---
# TALOS MACHINE CONFIGURATION
# This is a Jinja2 template that serves as the base configuration for all Talos machines in the cluster.
# It gets patched with node-specific configuration from talos/nodes/*.yaml.j2
# 
# KEY CONCEPTS:
# - "machine" section: Node-level OS configuration (kernel, network, security)
# - "cluster" section: Kubernetes-specific settings (only for control plane nodes)
# - {% if ENV.IS_CONTROLLER %}: Conditional sections that only apply to control plane nodes
# - op://...  secrets: These are 1Password secret references (requires op inject command)
#
# USAGE:
#   1. This gets templated with "just template talos/machineconfig.yaml.j2"
#   2. Then patched with node-specific config from talos/nodes/{node}.yaml.j2
#   3. Applied to node with "talosctl machineconfig patch"

---
# USER VOLUMES - Configure additional storage volumes on nodes
# This creates a volume from an NVMe drive matching the selector
apiVersion: v1alpha1
kind: UserVolumeConfig
metadata:
  name: local-hostpath
spec:
  # Provisioning: Automatically create and mount the volume
  provisioning:
    diskSelector:
      # Match specific disk by model and exclude system disk
      # "Corsair MP600 MICRO" is the specific SSD model
      # !system_disk: Don't use the boot drive
      match: disk.model == "Corsair MP600 MICRO" && !system_disk
    minSize: 1TB  # Require at least 1TB drive
---
# WATCHDOG TIMER - System watchdog to detect and recover from hangs
apiVersion: v1alpha1
kind: WatchdogTimerConfig
metadata:
  device: /dev/watchdog0  # System watchdog device
  timeout: 5m  # Reboot if system hangs for 5 minutes
---
version: v1alpha1
kind: Config

# ============================================================================
# MACHINE CONFIGURATION - Node Operating System Settings
# ============================================================================
machine:
  # CA Certificates - Talos uses these for internal API communication
  # The "crt" is always needed, "key" only needed on control plane nodes
  ca:
    crt: op://kubernetes/talos/MACHINE_CA_CRT
    {% if ENV.IS_CONTROLLER %}
    key: op://kubernetes/talos/MACHINE_CA_KEY
    {% endif %}

  # FEATURES - Enable/disable Talos features
  features:
    # Enable extended key usage checking for mTLS (more secure)
    apidCheckExtKeyUsage: true
    
    # Enable disk quota enforcement (for multi-tenancy)
    diskQuotaSupport: true
    
    # HostDNS: Use Talos as DNS forwarder for the node itself
    hostDNS:
      enabled: true
      # Forward DNS queries to the Kubernetes cluster DNS (requires Cilium socketLB)
      forwardKubeDNSToHost: true
      # Resolve Kubernetes service names on the host
      resolveMemberNames: true
    
    # KubePrism: Embedded proxy for Kubernetes API (makes cluster resilient)
    kubePrism:
      enabled: true
      port: 7445  # Port for the proxy
    
    # Only on control plane nodes:
    {% if ENV.IS_CONTROLLER %}
    # Allow specific Kubernetes namespaces to access Talos API
    # This lets Kubernetes controllers (like system-upgrade-controller) manage the OS
    kubernetesTalosAPIAccess:
      allowedKubernetesNamespaces:
        - actions-runner-system  # GitHub Actions runner needs Talos access
        - system-upgrade        # System upgrades controller needs Talos access
      allowedRoles:
        - os:admin  # Required role for full OS access
      enabled: true
    {% endif %}
    
    # Enable RBAC (role-based access control) for Talos API
    rbac: true
    
    # Keep hostname stable across reboots
    stableHostname: true

  # FILE MANAGEMENT - Create/modify OS files during boot
  files:
    # Configure containerd (container runtime) for special image handling
    - op: create
      path: /etc/cri/conf.d/20-customization.part
      content: |
        # Don't keep unpacked image layers (saves disk space)
        [plugins."io.containerd.cri.v1.images"]
          discard_unpacked_layers = false
        
        # Configure containerd runtime
        [plugins."io.containerd.cri.v1.runtime"]
          # Allow CDI (Container Device Interface) specs for device access
          cdi_spec_dirs = ["/var/cdi/static", "/var/cdi/dynamic"]
          # Allow containers to set device ownership from security context
          device_ownership_from_security_context = true
    
    # NFS mount options for optimal performance and reliability
    - op: overwrite
      path: /etc/nfsmount.conf
      permissions: 0o644
      content: |
        [ NFSMount_Global_Options ]
        nfsvers=4.2          # Use NFSv4.2 for latest features
        hard=True            # Hard mount (keep retrying instead of failing)
        nconnect=16          # 16 parallel TCP connections for performance
        noatime=True         # Don't update access time (improves performance)

  # INSTALLATION - Configure how Talos is installed on disk
  install:
    diskSelector:
      # Install only on this specific SSD model
      model: Samsung SSD 870
    # Factory image URL with specific customizations (from schematic.yaml.j2)
    image: factory.talos.dev/metal-installer/cc720ffb8efc8f12637b8660a86448a88b3f89f516995fb9c67bf80564e723b1:v1.11.5
    wipe: false  # Don't wipe existing partitions (safe for re-provisioning)

  # KERNEL MODULES - Load additional kernel modules
  kernel:
    modules:
      - name: nbd        # Network Block Device (for storage over network)
      - name: thunderbolt  # Thunderbolt support (for network adapters)

  # NODE LABELS - Kubernetes labels for this node
  # These help identify the node's hardware and capabilities
  nodeLabels:
    node.kubernetes.io/gpu: "true"           # Mark node as GPU-capable
    topology.kubernetes.io/region: main      # Region label for placement

  # KERNEL PARAMETERS - Optimize OS behavior for Kubernetes
  sysctls:
    # inotify: File system event monitoring (watch for changes)
    fs.inotify.max_user_instances: "8192"    # More application instances
    fs.inotify.max_user_watches: "1048576"   # Watch more files (1MB)
    
    # Network: Queueing discipline (how packets are queued)
    net.core.default_qdisc: fq  # Fair queuing for better network fairness
    
    # Network: Receive/transmit buffer sizes (2GB max each)
    net.core.rmem_max: "67108864"  # 64MB max receive buffer
    net.core.wmem_max: "67108864"  # 64MB max transmit buffer
    
    # ARP (Address Resolution Protocol) - neighbor table limits
    net.ipv4.neigh.default.gc_thresh1: "4096"   # Start cleanup at 4k entries
    net.ipv4.neigh.default.gc_thresh2: "8192"   # More aggressive cleanup
    net.ipv4.neigh.default.gc_thresh3: "16384"  # Maximum table size
    
    # Allow unprivileged processes to use ping (0-2147483647 = all users)
    net.ipv4.ping_group_range: "0 2147483647"
    
    # TCP: Congestion control algorithm (BBR = better than cubic)
    net.ipv4.tcp_congestion_control: bbr
    
    # TCP Fast Open: Reduce latency on new connections
    net.ipv4.tcp_fastopen: "3"  # Enable both send and receive
    
    # TCP MTU probing: Auto-discover optimal packet size
    net.ipv4.tcp_mtu_probing: "1"
    
    # TCP: Buffer sizes (min, default, max in bytes)
    net.ipv4.tcp_rmem: "4096 87380 33554432"    # 0.5KB to 32MB receive
    net.ipv4.tcp_wmem: "4096 65536 33554432"    # 4KB to 32MB transmit
    
    # TCP: Window scaling for large bandwidth-delay products
    net.ipv4.tcp_window_scaling: "1"
    
    # NFS: Parallel TCP connections for NFS over network
    sunrpc.tcp_max_slot_table_entries: "128"
    sunrpc.tcp_slot_table_entries: "128"
    
    # User namespace: Allow more nested container setups
    user.max_user_namespaces: "11255"
    
    # Memory: Allocate huge pages for performance
    vm.nr_hugepages: "1024"  # 1024 x 2MB = 2GB of huge pages

  # TALOS API TOKEN - Secret for Talos API authentication
  token: op://kubernetes/talos/MACHINE_TOKEN

  # UDEV RULES - Hardware-specific rules
  udev:
    rules:
      # Thunderbolt: Keep power management ON (don't auto-sleep)
      # This ensures Thunderbolt NICs stay connected
      - ACTION=="add", SUBSYSTEM=="thunderbolt", ATTR{power/control}="on"

  # KUBELET - Kubernetes node container runtime
  kubelet:
    # Use strict seccomp profile by default
    defaultRuntimeSeccompProfileEnabled: true
    
    # Don't load manifests from /etc/kubernetes/manifests
    # (Talos manages static pods differently)
    disableManifestsDirectory: true
    
    # Extra configuration
    extraConfig:
      # Enable ImageVolume feature gate (local container image management)
      featureGates:
        ImageVolume: true
      # Don't pull all images in parallel (prevents overwhelming network)
      serializeImagePulls: false
    
    # Use specific kubelet version
    image: ghcr.io/siderolabs/kubelet:v1.34.2
    
    # Restrict kubelet to specific subnet for this node
    # Useful if node has multiple network interfaces
    nodeIP:
      validSubnets:
        - 192.168.42.0/24

  # NETWORK - Network interface configuration
  network:
    # NIC interfaces and their configuration
    interfaces:
      # Main interface: bonded connection from two Thunderbolt adapters
      - interface: bond0
        # Bond configuration: two NICs in active-backup mode
        bond:
          deviceSelectors:
            # First Thunderbolt adapter (Intel driver, specific bus path)
            - driver: igc
              hardwareAddr: 88:ae:dd:72:*
          # Active-backup: if primary fails, switch to secondary
          mode: active-backup
        
        # Use DHCP for bond0 (main network)
        dhcp: true
        
        # Jumbo frames: 9000 byte MTU for better performance
        mtu: 9000
        
        # VLANs on top of bond0
        vlans:
          # VLAN 70: IoT network (separate from main cluster)
          - vlanId: 70
            dhcp: false
            mtu: 9000
          
          # VLAN 90: VPN network (for private connections)
          - vlanId: 90
            dhcp: false
            mtu: 9000

# ============================================================================
# CLUSTER CONFIGURATION - Kubernetes Settings (Control Plane Only)
# ============================================================================
cluster:
  # CA Certificates - For Kubernetes API and etcd
  ca:
    crt: op://kubernetes/talos/CLUSTER_CA_CRT
    {% if ENV.IS_CONTROLLER %}
    key: op://kubernetes/talos/CLUSTER_CA_KEY
    {% endif %}

  # Cluster name
  clusterName: main

  # Control plane endpoint: How to reach the Kubernetes API
  # "k8s.internal" should resolve to a load balancer or VIP
  controlPlane:
    endpoint: https://k8s.internal:6443

  # Cluster discovery: Let nodes find each other automatically
  discovery:
    enabled: true
    registries:
      # Don't use Kubernetes API registry (not available during bootstrap)
      kubernetes:
        disabled: true
      # Use service registry (nodes announce themselves)
      service:
        disabled: false

  # Cluster identity tokens (generated during cluster creation)
  id: op://kubernetes/talos/CLUSTER_ID
  secret: op://kubernetes/talos/CLUSTER_SECRET
  token: op://kubernetes/talos/CLUSTER_TOKEN

  # Network configuration
  network:
    # CNI: Cilium will be installed separately (name: none = no default CNI)
    cni:
      name: none
    
    # Kubernetes DNS domain
    dnsDomain: cluster.local
    
    # Pod network CIDR: Where pod IPs come from
    podSubnets:
      - 10.42.0.0/16
    
    # Service network CIDR: Where service IPs come from
    serviceSubnets:
      - 10.43.0.0/16

  # ============================================================
  # CONTROL PLANE ONLY CONFIGURATION
  # Everything below only applies to control plane nodes (IS_CONTROLLER=true)
  # ============================================================
  {% if ENV.IS_CONTROLLER %}

  # Aggregator CA: For API extension aggregation
  aggregatorCA:
    crt: op://kubernetes/talos/CLUSTER_AGGREGATORCA_CRT
    key: op://kubernetes/talos/CLUSTER_AGGREGATORCA_KEY

  # Allow Kubernetes workloads to be scheduled on control plane
  # (normally control planes are reserved for system pods only)
  allowSchedulingOnControlPlanes: true

  # Kubernetes API Server configuration
  apiServer:
    # Audit policy: Log API requests at Metadata level (who did what, but not contents)
    auditPolicy:
      apiVersion: audit.k8s.io/v1
      kind: Policy
      rules:
        - level: Metadata
    
    # Additional DNS names for API certificate (so external clients can connect)
    certSANs:
      - k8s.internal
    
    # Disable deprecated Pod Security Policy
    disablePodSecurityPolicy: true
    
    # Extra API server arguments
    extraArgs:
      # Enable API aggregation (for custom API resources)
      enable-aggregator-routing: "true"
      # Enable feature gates
      feature-gates: ImageVolume=true,MutatingAdmissionPolicy=true
      # Enable additional APIs
      runtime-config: admissionregistration.k8s.io/v1beta1=true
    
    # Kubernetes API server version
    image: registry.k8s.io/kube-apiserver:v1.34.2

  # Controller Manager: Runs various controllers (deployment, replicaset, etc.)
  controllerManager:
    extraArgs:
      # Listen on all interfaces (so metrics can be scraped)
      bind-address: 0.0.0.0
    image: registry.k8s.io/kube-controller-manager:v1.34.2

  # CoreDNS: Disabled because we'll use Cilium's DNS management instead
  coreDNS:
    disabled: true

  # etcd: Distributed key-value store for Kubernetes state
  etcd:
    # Tell other nodes how to reach this etcd instance
    advertisedSubnets:
      - 192.168.42.0/24
    
    # etcd CA certificates
    ca:
      crt: op://kubernetes/talos/CLUSTER_ETCD_CA_CRT
      key: op://kubernetes/talos/CLUSTER_ETCD_CA_KEY
    
    # Extra etcd arguments
    extraArgs:
      # Export metrics on all interfaces
      listen-metrics-urls: http://0.0.0.0:2381

  # kube-proxy: Disabled (Cilium will provide networking)
  proxy:
    disabled: true
    image: registry.k8s.io/kube-proxy:v1.34.2

  # Scheduler: Decides which pod goes on which node
  scheduler:
    # Advanced scheduler configuration
    config:
      apiVersion: kubescheduler.config.k8s.io/v1
      kind: KubeSchedulerConfiguration
      profiles:
        - schedulerName: default-scheduler
          plugins:
            # Disable ImageLocality scoring (don't prefer nodes with image)
            score:
              disabled:
                - name: ImageLocality
          # Plugin configuration
          pluginConfig:
            # Pod Topology Spread: Spread pods across nodes and zones
            - name: PodTopologySpread
              args:
                defaultingType: List
                # Default: spread pods evenly, fail if can't spread
                defaultConstraints:
                  - maxSkew: 1  # Allow max 1 pod difference
                    topologyKey: kubernetes.io/hostname
                    whenUnsatisfiable: ScheduleAnyway
    
    # Extra scheduler arguments
    extraArgs:
      bind-address: 0.0.0.0  # Listen on all interfaces
    
    # Scheduler version
    image: registry.k8s.io/kube-scheduler:v1.34.2

  # Secret Box: Encryption key for Kubernetes secret encryption at rest
  secretboxEncryptionSecret: op://kubernetes/talos/CLUSTER_SECRETBOXENCRYPTIONSECRET

  # Service Account: Token signing key for service accounts
  serviceAccount:
    key: op://kubernetes/talos/CLUSTER_SERVICEACCOUNT_KEY

  {% endif %}
---
# ADDITIONAL USER VOLUMES (also defined at top of file)
# This appears twice because it's used for both storage provisioning options
apiVersion: v1alpha1
kind: UserVolumeConfig
metadata:
  name: local-hostpath
spec:
  provisioning:
    diskSelector:
      match: disk.model == "Corsair MP600 MICRO" && !system_disk
    minSize: 1TB
